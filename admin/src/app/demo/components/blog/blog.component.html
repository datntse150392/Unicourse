<div class="grid">
	<div class="col-12">
		<div class="card">
			<p-toast></p-toast>
			<p-toolbar styleClass="mb-4">
				<ng-template pTemplate="left">
					<div class="my-2">
						<button pButton pRipple label="New" icon="pi pi-plus" class="p-button-success mr-2"
							(click)="openNew()"></button>
						<button pButton pRipple label="Delete" icon="pi pi-trash" class="p-button-danger"
							(click)="deleteSelectedProducts()"
							[disabled]="!selectedProducts || !selectedProducts.length"></button>
					</div>
				</ng-template>

				<ng-template pTemplate="right">
					<p-fileUpload mode="basic" accept="image/*" [maxFileSize]="1000000" label="Import"
						chooseLabel="Import" class="mr-2 inline-block"></p-fileUpload>
					<button pButton pRipple label="Export" icon="pi pi-upload" class="p-button-help"
						(click)="exportExcel()"></button>
				</ng-template>
			</p-toolbar>
			<h5>Danh sách bài đăng</h5>
			<p-table #dt1 [value]="blogs" dataKey="id" [rows]="10" [loading]="loading" [rowHover]="true"
				styleClass="p-datatable-gridlines" [paginator]="true"
				[globalFilterFields]="['title', 'userId.fullName', 'date', 'status']" responsiveLayout="scroll">
				<ng-template pTemplate="caption">
					<div class="flex justify-content-between flex-column sm:flex-row">
						<button pButton label="Clear" class="p-button-outlined mb-2" icon="pi pi-filter-slash"
							(click)="clear(dt1)"></button>
						<span class="p-input-icon-left mb-2">
							<i class="pi pi-search"></i>
							<input pInputText type="text" #filter (input)="onGlobalFilter(dt1, $event)"
								placeholder="Search Keyword" class="w-full" />
						</span>
					</div>
				</ng-template>
				<ng-template pTemplate="header">
					<tr>
						<th style="min-width: 8rem">
							<div class="flex justify-content-between align-items-center">
								Bài đăng
								<p-columnFilter type="text" field="title" display="menu"
									placeholder="Nhập tiêu đề"></p-columnFilter>
							</div>
						</th>
						<th style="min-width: 8rem">
							<div class="flex justify-content-between align-items-center">
								Ảnh thumbnail
							</div>
						</th>
						<th style="min-width: 14rem">
							<div class="flex justify-content-between align-items-center">
								Tác giả
								<p-columnFilter type="text" field="userId.fullName" display="menu"
									placeholder="Nhập tên tác giả"></p-columnFilter>
							</div>
						</th>
						<th style="min-width: 12rem">
							<div class="flex justify-content-between align-items-center">
								Nhãn dán
							</div>
						</th>
						<th style="min-width: 8rem">
							<div class="flex justify-content-between align-items-center">
								Ngày đăng
							</div>
						</th>
						<th style="min-width: 10rem">
							<div class="flex justify-content-between align-items-center">
								Trạng thái
								<p-columnFilter field="status" matchMode="equals" display="menu">
									<ng-template pTemplate="filter" let-value let-filter="filterCallback">
										<p-dropdown [ngModel]="value" [options]="statuses"
											(onChange)="filter($event.value)" placeholder="Any"
											[style]="{'min-width': '12rem'}">
											<ng-template let-option pTemplate="item">
												<span
													[class]="'customer-badge status-' + option.value">{{option.label}}</span>
											</ng-template>
										</p-dropdown>
									</ng-template>
								</p-columnFilter>
							</div>
						</th>
						<th style="min-width:10rem"></th>
					</tr>
				</ng-template>
				<ng-template pTemplate="body" let-blog>
					<tr>
						<td>
							<p class="truncated-text" [pTooltip]="blog.title">
								{{blog.title}}
							</p>
						</td>
						<td>
							<div *ngIf="blog.thumbnail_url" class="group-thumbnail">
								<img [src]="blog.thumbnail_url" [class]="'thumbnail flag flag-' + blog.title">
							</div>
							<div *ngIf="!blog.thumbnail_url" class="group-thumbnail">
								<img src="assets/layout/images/default-blog.png" [class]="'thumbnail flag flag-' + blog.title">
							</div>
						</td>
						<td>
							<div class="group-avatar">
								<img class="avatar" [alt]="blog.userId.fullName" [src]="blog.userId.profile_image"
									style="vertical-align: middle; border-radius: 5px" />
								<span class="image-text ml-2">{{blog.userId.fullName}}</span>
							</div>
						</td>
						<td>
							<div class="tags">
								<ng-container *ngFor="let tag of blog.tags">
									<span *ngIf="tag" [style.background]="tag.color" style="color: white; text-align: center" [class]="'customer-badge status-' + blog.status">{{tag.name}}</span>
								</ng-container>
								<ng-container *ngIf="!blog.tags || blog.tags.length === 0">
									<span style="background: #CCCCCC; color: white; text-align: center" [class]="'customer-badge status-' + blog.status">Chọn nhãn dán</span>
								</ng-container>
							</div>
						</td>
						<td>
							{{blog.date_published | date : "dd/MM/yyyy"}}
						</td>
						<td>
							<span [value]="blog.status"
								[class]="'customer-badge status-' + blog.status">{{blog.status}}</span>
						</td>
						<td>
							<button pButton pRipple type="button" icon="pi pi-pencil"
								class="p-button-rounded p-button-success mr-2" (click)="popupEditDialog(blog)"></button>
							<button pButton type="button" pRipple icon="pi pi-trash"
								class="p-button-rounded p-button-warning" (click)="deleteBlog(blog)"></button>
						</td>
					</tr>
				</ng-template>

				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="8">No customers found.</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="loadingbody">
					<tr>
						<td colspan="8">Loading customers data. Please wait.</td>
					</tr>
				</ng-template>
			</p-table>
		</div>

		<!-- Chỉnh sửa blog -->
		<p-dialog [(visible)]="blogDialog" [style]="{width: '50%'}" header="Chi tiết bài viết" [modal]="true"
			class="p-fluid">
			<ng-template pTemplate="content">
				<div class="field">
					<label for="status">Nổi bật</label>
					<div>
						<p-inputSwitch [(ngModel)]="blog.flag" name="flag" (onChange)="onBlogChange(blog.flag, 'flag')"></p-inputSwitch>
					</div>
				</div>
				
				<div *ngIf="blog.thumbnail_url !== ''" class="field">
					<label for="thumbnail">Ảnh thumbnail</label>
					<div class="thumbnail-detail">
						<p-image [src]="blog.thumbnail_url" [previewImageSrc]="blog.thumbnail_url" alt="blog.title" width="250" imageStyle="border-radius: 1rem;" [preview]="true"></p-image>
					</div>
				</div>

				<div class="field">
					<label *ngIf="blog.thumbnail_url !== ''" for="thumbnail">Chính sửa ảnh thumbnail</label>
					<label *ngIf="blog.thumbnail_url === ''" for="thumbnail">Thêm ảnh thumbnail</label>
					<p-fileUpload name="demo[]" url="https://www.primefaces.org/cdn/api/upload.php" (onUpload)="onUpload($event)" accept="image/*" maxFileSize="1000000">
						<ng-template pTemplate="content">
							<p *ngIf="uploadedFiles">{{ file.name }} - {{ file.size }} bytes</p>
						</ng-template>
					</p-fileUpload>
				</div>

				<div class="field">
					<label for="title">Tiêu đề</label>
					<input type="text" pInputText id="title" [(ngModel)]="blog.title" name="title" (ngModelChange)="onBlogChange(blog.title, 'title')" required autofocus
						[ngClass]="{'ng-invalid ng-dirty' : submitted && !blog.title}" />
					<small class="ng-dirty ng-invalid" *ngIf="submitted && !blog.title">Tiêu đề không được trống.</small>
				</div>

				<div class="field">
					<label for="description">Mô tả</label>
					<textarea id="description" pInputTextarea [(ngModel)]="blog.description" name="description" (ngModelChange)="onBlogChange(blog.description, 'description')" required rows="3"
						cols="20"></textarea>
				</div>

				<!-- Editor -->
				<div class="field editor">
					<label for="status">Nội dung</label>
					<!-- Editor Text -->
					<div>
						<ng-container *ngIf="preview; else preViewBlog">
							<editor [(ngModel)]="blog.content" name="content" (ngModelChange)="onBlogChange(blog.content, 'content')" apiKey="8oi2m4vzjnoj301r398iggki6v0ukdgpwavrr76kku9cnnpz"
								[init]="{ plugins: 'lists link image table code help wordcount' }"></editor>
				
							<button *ngIf="blog.content" (click)="togglePreview()" pButton pRipple label="Xem trước"
								class="btn-view-demo p-button-success"></button>
						</ng-container>
						<ng-template #preViewBlog>
							<div class="card">
								<div class="w-full h-full" *ngIf="blog.content" [innerHTML]="sanitizeContent(blog.content)"></div>
							</div>
							<button (click)="togglePreview()" pButton pRipple label="Trở về"
								class="btn-view-demo p-button-success"></button>
						</ng-template>
					</div>
				</div>

				<div class="field">
					<label for="description">Nhãn dán</label>
					<p-multiSelect [options]="tags" [(ngModel)]="selectedTags" name="tags" (ngModelChange)="onBlogChange(selectedTags, 'tags')" placeholder="Chọn nhãn dán" optionLabel="name">
						<ng-template let-tag pTemplate="item">
							<div class="flex align-items-center gap-2">
								<p-colorPicker [(ngModel)]="tag.color" [disabled]="true"></p-colorPicker>
								<div>{{ tag.name }}</div>
							</div>
						</ng-template>
					</p-multiSelect>
				</div>

				<div class="field">
					<label for="status">Trạng thái</label>
					<p-selectButton [options]="statusOptions" [(ngModel)]="selectedStatus" name="tags" (ngModelChange)="onBlogChange(selectedStatus, 'status')" optionLabel="name" optionValue="value"></p-selectButton>
				</div>
				
			</ng-template>

			<ng-template pTemplate="footer">
				<button pButton pRipple label="Hủy" icon="pi pi-times" class="p-button-text"
					(click)="hideDialog()"></button>
				<button [disabled]="disableSubmitBtn" pButton pRipple label="Lưu" icon="pi pi-check" class="p-button-text"
					(click)="saveBLog()"></button>
			</ng-template>
		</p-dialog>

		<p-dialog [(visible)]="deleteBlogDialog" header="Confirm" [modal]="true" [style]="{width:'450px'}">
			<div class="flex align-items-center justify-content-center">
				<i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
				<span *ngIf="blog">Bạn muốn xóa bài viết <b>{{blog.title}}</b>?</span>
			</div>
			<ng-template pTemplate="footer">
				<button pButton pRipple icon="pi pi-times" class="p-button-text" label="No"
					(click)="deleteBlogDialog = false"></button>
				<button pButton pRipple icon="pi pi-check" class="p-button-text" label="Yes"
					(click)="confirmDelete()"></button>
			</ng-template>
		</p-dialog>
	</div>
</div>